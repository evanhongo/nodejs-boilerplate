stages:
  - test
  - build

variables:
  GCP_PROJECT_ID: girls-frontline-336616
  REGISTRY: gcr.io/${GCP_PROJECT_ID}
  IMAGE: ${REGISTRY}/gf-server:${CI_COMMIT_REF_NAME}

unit-test:
  only:
    refs:
      - tags
  stage: test
  image: node:19.4.0
  before_script:
    # Install dependencies
    - npm install -g pnpm
    - pnpm install
  script:
    - pnpm run test

build-and-push-image:
  only:
    refs:
      - tags
  stage: build
  needs: [unit-test]
  image: docker:20.10.7-dind
  before_script:
    # Login to gcr
    # GCR_SECRET is keyfile.json generated by google service account and stored in environment variables of gitlab ci pipeline system
    # Get more information at https://cloud.google.com/container-registry/docs/advanced-authentication#json-key
    - echo ${GCR_SECRET} | base64 -d | docker login -u _json_key --password-stdin gcr.io
  script:
    - docker build -t ${IMAGE} . && docker push ${IMAGE}
